#

CONFIG_F = "../config.json" 
configfile: CONFIG_F

rule all:
    input:
        '{}/datasets/train_set.untampered_bulk_primary_cells_with_data/labels.json'.format(config['env_dir']),
        '{env}/datasets/train_set.untampered_bulk_primary_cells_with_data/{feats}.h5'.format(
            env=config['env_dir'],
            feats='log_tpm'
        ),
        '{}/datasets/test_set.untampered_bulk_primary_cells_with_data/labels.json'.format(config['env_dir']),
        '{env}/datasets/test_set.untampered_bulk_primary_cells_with_data/{feats}.h5'.format(
            env=config['env_dir'],
            feats='log_tpm'
        ),
        '{}/datasets/untampered_bulk_primary_cells_with_data/labels.json'.format(config['env_dir']),
        '{env}/datasets/untampered_bulk_primary_cells_with_data/{feats}.h5'.format(
            env=config['env_dir'],
            feats='log_tpm'
        ) 

#############################################################################
#   Build the annotation file
#############################################################################
rule apply_annotation:
    input:
        config['annotation_file']
    output:
        '{}/annotation.json'.format(config['env_dir'])
    run:
        commands = [
            'mkdir -p {}'.format(config['env_dir']),
            'python apply_annotation.py {} {{output}}'.format(CONFIG_F)
        ]
        for c in commands:
            shell('echo "{}"'.format(c))
            shell(c)

#############################################################################
#   This finds all bulk samples that are 'untampered' -- that is, haven't
#   been in vitro differentiated or otherwise treated to induce a gene
#   expression change 
#############################################################################
rule select_all_untampered_bulk_exps_w_data:
    input:
        '{}/annotation.json'.format(config['env_dir'])
    output:
        '{}/experiment_sets/all_untampered_bulk_primary_cells_with_data.json'.format(config['env_dir'])
    run:
        commands = [
            'mkdir -p {}/data/experiment_sets'.format(config['env_dir']),
            'python {src}/build_dataset/data_selection/all_untampered_bulk_primary_cells_with_data.py {annot_f} -o {{output}}'.format(
                src=config['cello_dev'],
                annot_f=config['annotation_file']
            )
        ]
        for c in commands:
            shell('echo "{}"'.format(c))
            shell(c)

###############################################################################
#   Given a partitioning of training studies and test studies, this step forms
#   the two experiment sets corresponding to the training set and test set.
###############################################################################
rule select_train_test_experiment_sets:
    input:
        annot='{}/annotation.json'.format(config['env_dir']),
        exp_set='{}/experiment_sets/all_untampered_bulk_primary_cells_with_data.json'.format(config['env_dir']),
    output:
        train='{}/experiment_sets/train_set.untampered_bulk_primary_cells_with_data.json'.format(config['env_dir']),
        test='{}/experiment_sets/test_set.untampered_bulk_primary_cells_with_data.json'.format(config['env_dir'])
    run:
        commands = [
            'python {src}/build_dataset/data_selection/train_test_from_untampered_bulk_primary_cells_with_data.py {{input.annot}} {{input.exp_set}} {src}/build_dataset/data_selection/train_test_partition_data.untampered_bulk_primary_cells_with_data.v4.json -r {{output.train}} -e {{output.test}}'.format(
                src=config['cello_dev']
            )
        ]
        for c in commands:
            shell('echo "{}"'.format(c))
            shell(c)

rule build_train_test_experiment_log_tpm_dataset:
    input:
        train='{}/experiment_sets/train_set.untampered_bulk_primary_cells_with_data.json'.format(config['env_dir']),
        test='{}/experiment_sets/test_set.untampered_bulk_primary_cells_with_data.json'.format(config['env_dir'])
    output:
        train='{env}/datasets/train_set.untampered_bulk_primary_cells_with_data/{feats}.h5'.format(
            env=config['env_dir'],
            feats='log_tpm'
        ),
        test='{env}/datasets/test_set.untampered_bulk_primary_cells_with_data/{feats}.h5'.format(
            env=config['env_dir'],
            feats='log_tpm'
        )
    run:
        commands = [
            'mkdir -p {}/datasets/train_set.untampered_bulk_primary_cells_with_data'.format(config['env_dir']),
            'mkdir -p {}/datasets/test_set.untampered_bulk_primary_cells_with_data'.format(config['env_dir']),
            'python {src}/build_dataset/build_expression_matrix.py {{input.train}} {feats} -o {{output.train}}'.format(
                src=config['cello_dev'],
                feats='log_tpm'
            ),
            'python {src}/build_dataset/build_expression_matrix.py {{input.test}} {feats} -o {{output.test}}'.format(
                src=config['cello_dev'],
                feats='log_tpm'
            )
        ]
        for c in commands:
            shell('echo "{}"'.format(c))
            shell(c)


rule label_train_test_experiment_sets:
    input:
        train='{}/experiment_sets/train_set.untampered_bulk_primary_cells_with_data.json'.format(config['env_dir']),
        test='{}/experiment_sets/test_set.untampered_bulk_primary_cells_with_data.json'.format(config['env_dir'])
    output:
        train='{}/datasets/train_set.untampered_bulk_primary_cells_with_data/labels.json'.format(config['env_dir']),
        test='{}/datasets/test_set.untampered_bulk_primary_cells_with_data/labels.json'.format(config['env_dir'])
    run:
        commands = [
            'mkdir -p {}/datasets/train_set.untampered_bulk_primary_cells_with_data'.format(config['env_dir']),
            'mkdir -p {}/datasets/test_set.untampered_bulk_primary_cells_with_data'.format(config['env_dir']),
            'python {src}/build_dataset/label_data.py {env}/annotation.json {{input.train}} -o {{output.train}}'.format(
                src=config['cello_dev'],
                env=config['env_dir']
            ),
            'python {src}/build_dataset/label_data.py {env}/annotation.json {{input.test}} -o {{output.test}}'.format(
                src=config['cello_dev'],
                env=config['env_dir']
            )
        ]
        for c in commands:
            shell('echo "{}"'.format(c))
            shell(c)

rule metadata_train_test_experiment_sets:
    input:
        train='{}/experiment_sets/train_set.untampered_bulk_primary_cells_with_data.json'.format(config['env_dir']),
        test='{}/experiment_sets/test_set.untampered_bulk_primary_cells_with_data.json'.format(config['env_dir'])
    output:
        train_study='{}/datasets/train_set.untampered_bulk_primary_cells_with_data/experiment_to_study.json'.format(config['env_dir']),
        test_study='{}/datasets/test_set.untampered_bulk_primary_cells_with_data/experiment_to_study.json'.format(config['env_dir']),
        train_tags='{}/datasets/train_set.untampered_bulk_primary_cells_with_data/experiment_to_tags.json'.format(config['env_dir']),
        test_tags='{}/datasets/test_set.untampered_bulk_primary_cells_with_data/experiment_to_tags.json'.format(config['env_dir']),
    run:
        commands = [
            'mkdir -p {}/datasets/train_set.untampered_bulk_primary_cells_with_data'.format(config['env_dir']),
            'mkdir -p {}/datasets/test_set.untampered_bulk_primary_cells_with_data'.format(config['env_dir']),
            'python {src}/build_dataset/build_study_metadata_file.py {{input.train}} {env}/annotation.json -o {{output.train_study}}'.format(
                src=config['cello_dev'],
                env=config['env_dir']
            ),
            'python {src}/build_dataset/build_study_metadata_file.py {{input.test}} {env}/annotation.json -o {{output.test_study}}'.format(
                src=config['cello_dev'],
                env=config['env_dir']
            ),
            'python {src}/build_dataset/build_tags_metadata_file.py {{input.train}} {env}/annotation.json -o {{output.train_tags}}'.format(
                src=config['cello_dev'],
                env=config['env_dir']
            ),
            'python {src}/build_dataset/build_tags_metadata_file.py {{input.test}} {env}/annotation.json -o {{output.test_tags}}'.format(
                src=config['cello_dev'],
                env=config['env_dir']
            )
        ]
        for c in commands: 
            shell('echo "{}"'.format(c))
            shell(c)

##############################################################################
# Note that test_set.untampered_bulk_primary_cells_with_data unioned with 
# train_set.untampered_bulk_primary_cells_with_data may be a subset of 
#  all_untampered_bulk_primary_cells_with_data. The reason being that we do
#  not keep cell type samples that are only represented by a single-study.
#
# Therefore, this step forms the union of 
# train_set.untampered_bulk_primary_cells_with_data and 
# test_set.untampered_bulk_primary_cells_with_data, which will be the full 
# bulk RNA-seq dataset used for many downstream analyses.
###############################################################################
rule select_untampered_bulk_primary_cells_with_data:
    input:
        train='{}/experiment_sets/train_set.untampered_bulk_primary_cells_with_data.json'.format(config['env_dir']),
        test='{}/experiment_sets/test_set.untampered_bulk_primary_cells_with_data.json'.format(config['env_dir'])
    output:
        '{}/experiment_sets/untampered_bulk_primary_cells_with_data.json'.format(config['env_dir'])
    run:
        commands = [
            'mkdir -p {}/experiment_sets/untampered_bulk_primary_cells_with_data'.format(config['env_dir']),
            'python {src}/build_dataset/data_selection/union_train_test.py {{input.train}} {{input.test}} -o {{output}}'.format(
                src=config['cello_dev']
            )
        ]
        for c in commands:
            shell(c)

rule build_untampered_bulk_primary_cells_with_data_log_tpm_dataset:
    input:
        '{}/experiment_sets/untampered_bulk_primary_cells_with_data.json'.format(config['env_dir']),
    output:
        '{env}/datasets/untampered_bulk_primary_cells_with_data/{feats}.h5'.format(
            env=config['env_dir'],
            feats='log_tpm'
        )
    run:
        commands = [
            'mkdir -p {}/datasets/untampered_bulk_primary_cells_with_data'.format(config['env_dir']),
            'python {src}/build_dataset/build_expression_matrix.py {{input}} {feats} -o {{output}}'.format(
                src=config['cello_dev'],
                feats='log_tpm'
            )
        ]
        for c in commands:
            shell('echo "{}"'.format(c))
            shell(c)

rule build_untampered_bulk_primary_cells_with_data_log_tpm_10x_genes_dataset:
    input:
        '{}/experiment_sets/untampered_bulk_primary_cells_with_data.json'.format(config['env_dir']),
    output:
        '{env}/datasets/untampered_bulk_primary_cells_with_data/{feats}.h5'.format(
            env=config['env_dir'],
            feats='log_tpm_10x_genes'
        )
    run:
        commands = [
            'mkdir -p {}/datasets/untampered_bulk_primary_cells_with_data'.format(config['env_dir']),
            'python {src}/build_dataset/build_expression_matrix.py {{input}} {feats} -o {{output}}'.format(
                src=config['cello_dev'],
                feats='log_tpm_10x_genes'
            )
        ]
        for c in commands:
            shell('echo "{}"'.format(c))
            shell(c)

rule label_untampered_bulk_primary_cells_with_data:
    input:
        '{}/experiment_sets/untampered_bulk_primary_cells_with_data.json'.format(config['env_dir'])
    output:
        '{}/datasets/untampered_bulk_primary_cells_with_data/labels.json'.format(config['env_dir'])
    run:
        commands = [
            'mkdir -p {}/datasets/untampered_bulk_primary_cells_with_data'.format(config['env_dir']),
            'python {src}/build_dataset/label_data.py {env}/annotation.json {{input}} -o {{output}}'.format(
                src=config['cello_dev'],
                env=config['env_dir']
            )
        ]
        for c in commands:
            shell(c)

rule metadata_untampered_bulk_primary_cells_with_data:
    input:
        '{}/experiment_sets/untampered_bulk_primary_cells_with_data.json'.format(config['env_dir'])
    output:
        study='{}/datasets/untampered_bulk_primary_cells_with_data/experiment_to_study.json'.format(config['env_dir']),
        tags='{}/datasets/untampered_bulk_primary_cells_with_data/experiment_to_tags.json'.format(config['env_dir'])
    run:
        commands = [
            'mkdir -p {}/datasets/untampered_bulk_primary_cells_with_data'.format(config['env_dir']),
            'python {src}/build_dataset/build_study_metadata_file.py {{input}} {env}/annotation.json -o {{output.study}}'.format(
                src=config['cello_dev'],
                env=config['env_dir']
            ),
            'python {src}/build_dataset/build_tags_metadata_file.py {{input}} {env}/annotation.json -o {{output.tags}}'.format(
                src=config['cello_dev'],
                env=config['env_dir']
            )
        ]
        for c in commands:
            shell('echo "{}"'.format(c))
            shell(c)


###############################################################################################
#   Select all untampered single cell samples
###############################################################################################

rule select_untampered_single_cell_primary_cells_with_data:
    input:
        annot='{}/annotation.json'.format(config['env_dir']),
    output:
        '{}/experiment_sets/untampered_single_cell_primary_cells_with_data.json'.format(config['env_dir'])
    run:
        commands = [
            'mkdir -p {}/experiment_sets'.format(config['env_dir']),
            'python {src}/build_dataset/data_selection/untampered_single_cell_primary_cells_with_data.py {annot} -o {{output}}'.format(
                src=config['cello_dev'],
                annot=config['annotation_file']
            )
        ]
        for c in commands:
            shell(c)

rule label_untampered_single_cell_primary_cells_with_data:
    input:
        '{}/experiment_sets/untampered_single_cell_primary_cells_with_data.json'.format(config['env_dir'])
    output:
        '{}/datasets/untampered_single_cell_primary_cells_with_data/labels.json'.format(config['env_dir'])
    run:
        commands = [
            'mkdir -p {}/datasets/untampered_single_cell_primary_cells_with_data'.format(config['env_dir']),
            'python {src}/build_dataset/label_data.py {env}/annotation.json {{input}} -o {{output}}'.format(
                src=config['cello_dev'],
                env=config['env_dir']
            )
        ]
        for c in commands:
            shell(c)

rule select_untampered_single_cell_primary_cells_with_data_cell_types_in_bulk:
    input:
        sc_exp='{}/experiment_sets/untampered_single_cell_primary_cells_with_data.json'.format(config['env_dir']),
        sc_lab='{}/datasets/untampered_single_cell_primary_cells_with_data/labels.json'.format(config['env_dir']),
        b_exp='{}/experiment_sets/untampered_bulk_primary_cells_with_data.json'.format(config['env_dir']),
        b_lab='{}/datasets/untampered_bulk_primary_cells_with_data/labels.json'.format(config['env_dir'])
    output:
        '{}/experiment_sets/untampered_single_cell_primary_cells_with_data_cell_types_in_bulk.json'.format(config['env_dir'])
    run:
        commands = [
            'mkdir -p {}/data/experiment_lists/untampered_single_cell_primary_cells_with_data_cell_types_in_bulk'.format(config['env_dir']),
            'python {src}/build_dataset/data_selection/untampered_single_cell_primary_cells_with_data_cell_types_in_bulk.py {{input.sc_exp}} {{input.b_exp}} {{input.sc_lab}} {{input.b_lab}} -o {{output}}'.format(
                src=config['cello_dev']
            )
        ]
        for c in commands:
            shell(c)


rule build_untampered_single_cell_primary_cells_with_data_cell_types_in_bulk:
    input:
        '{}/experiment_sets/untampered_single_cell_primary_cells_with_data_cell_types_in_bulk.json'.format(config['env_dir']),
    output:
        '{env}/datasets/untampered_single_cell_primary_cells_with_data_cell_types_in_bulk/{feats}.h5'.format(
            env=config['env_dir'],
            feats='log_tpm'
        )
    run:
        commands = [
            'mkdir -p {}/datasets/untampered_single_cell_primary_cells_with_data_cell_types_in_bulk'.format(config['env_dir']),
            'python {src}/build_dataset/build_expression_matrix.py {{input}} {feats} -o {{output}}'.format(
                src=config['cello_dev'],
                feats='log_tpm'
            )
        ]
        for c in commands:
            shell('echo "{}"'.format(c))
            shell(c)


rule label_untampered_single_cell_primary_cells_with_data_cell_types_in_bulk:
    input:
        '{}/experiment_sets/untampered_single_cell_primary_cells_with_data_cell_types_in_bulk.json'.format(config['env_dir'])
    output:
        '{}/datasets/untampered_single_cell_primary_cells_with_data_cell_types_in_bulk/labels.json'.format(config['env_dir'])
    run:
        commands = [
            'mkdir -p {}/datasets/untampered_single_cell_primary_cells_with_data_cell_types_in_bulk'.format(config['env_dir']),
            'python {src}/build_dataset/label_data.py {env}/annotation.json {{input}} -o {{output}}'.format(
                src=config['cello_dev'],
                env=config['env_dir']
            )
        ]
        for c in commands:
            shell(c)

rule metadata_untampered_single_cell_primary_cells_with_data_cell_types_in_bulk:
    input:
        '{}/experiment_sets/untampered_single_cell_primary_cells_with_data_cell_types_in_bulk.json'.format(config['env_dir'])
    output:
        study='{}/datasets/untampered_single_cell_primary_cells_with_data_cell_types_in_bulk/experiment_to_study.json'.format(config['env_dir']),
        tags='{}/datasets/untampered_single_cell_primary_cells_with_data_cell_types_in_bulk/experiment_to_tags.json'.format(config['env_dir'])
    run:
        commands = [
            'mkdir -p {}/datasets/untampered_bulk_primary_cells_with_data'.format(config['env_dir']),
            'python {src}/build_dataset/build_study_metadata_file.py {{input}} {env}/annotation.json -o {{output.study}}'.format(
                src=config['cello_dev'],
                env=config['env_dir']
            ),
            'python {src}/build_dataset/build_tags_metadata_file.py {{input}} {env}/annotation.json -o {{output.tags}}'.format(
                src=config['cello_dev'],
                env=config['env_dir']
            )
        ]
        for c in commands:
            shell('echo "{}"'.format(c))
            shell(c)

##########################################################################################
#   10x Zheng et al. sorted PBMC dataset
##########################################################################################

rule build_10x_log_cpm:
    output:
        '{}/datasets/zheng_10x_PBMC_2000_cells_per_type/log_cpm.h5'.format(config['env_dir'])
    run:
        commands = [
            'mkdir -p {}/datasets/zheng_10x_PBMC_2000_cells_per_type'.format(config['env_dir']),
            'python build_expression_matrix_from_10x.py 2000 -o {output}'
        ]
        for c in commands:
            shell('echo "{}"'.format(c))
            shell(c)

rule build_10x_log_cpm_magic:
    input:
        '{}/datasets/zheng_10x_PBMC_2000_cells_per_type/log_cpm.h5'.format(config['env_dir'])
    output:
        '{}/datasets/zheng_10x_PBMC_2000_cells_per_type/log_cpm_magic.h5'.format(config['env_dir'])
    run:
        commands = [
            'python run_magic.py {input} -o {output}'
        ]
        for c in commands:
            shell('echo "{}"'.format(c))
            shell(c)

rule build_10x_log_cpm_leiden_0_8_magic:
    input:
        '{}/datasets/zheng_10x_PBMC_2000_cells_per_type/log_cpm.h5'.format(config['env_dir'])
    output:
        '{}/datasets/zheng_10x_PBMC_2000_cells_per_type/log_cpm_leiden_0_8_magic.h5'.format(config['env_dir'])
    run:
        commands = [
            'python cluster_and_run_magic.py {input} 0.8 -o {output}'
        ]
        for c in commands:
            shell('echo "{}"'.format(c))
            shell(c)

rule build_10x_log_cpm_leiden_1_6_magic:
    input:
        '{}/datasets/zheng_10x_PBMC_2000_cells_per_type/log_cpm.h5'.format(config['env_dir'])
    output:
        '{}/datasets/zheng_10x_PBMC_2000_cells_per_type/log_cpm_leiden_1_6_magic.h5'.format(config['env_dir'])
    run:
        commands = [
            'python cluster_and_run_magic.py {input} 1.6 -o {output}'
        ]
        for c in commands:
            shell('echo "{}"'.format(c))
            shell(c)

rule build_10x_log_cpm_leiden_3_2_magic:
    input:
        '{}/datasets/zheng_10x_PBMC_2000_cells_per_type/log_cpm.h5'.format(config['env_dir'])
    output:
        '{}/datasets/zheng_10x_PBMC_2000_cells_per_type/log_cpm_leiden_3_2_magic.h5'.format(config['env_dir'])
    run:
        commands = [
            'python cluster_and_run_magic.py {input} 3.2 -o {output}'
        ]
        for c in commands:
            shell('echo "{}"'.format(c))
            shell(c)


rule label_10x:
    input:
        '{}/datasets/zheng_10x_PBMC_2000_cells_per_type/log_cpm.h5'.format(config['env_dir'])
    output:
        '{}/datasets/zheng_10x_PBMC_2000_cells_per_type/labels.json'.format(config['env_dir'])
    run:    
        commands = [
            'python label_10x_data.py {input} -o {output}'
        ]
        for c in commands:
            shell('echo "{}"'.format(c))
            shell(c)

rule metadata_10x:
    input:
        '{}/datasets/zheng_10x_PBMC_2000_cells_per_type/log_cpm.h5'.format(config['env_dir'])
    output:
        study='{}/datasets/zheng_10x_PBMC_2000_cells_per_type/experiment_to_study.json'.format(config['env_dir']),
        tags='{}/datasets/zheng_10x_PBMC_2000_cells_per_type/experiment_to_tags.json'.format(config['env_dir'])
    run:
        commands = [
            'python build_study_metadata_file_10x.py {input} -o {output.study}',
            'python build_tags_metadata_file_10x.py {input} -o {output.tags}'
        ]
        for c in commands:
            shell('echo "{}"'.format(c))
            shell(c)
